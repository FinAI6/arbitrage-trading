import os, time, hmac, hashlib, requests, urllib.parse
from dotenv import load_dotenv

load_dotenv()
API_KEY    = os.getenv("BINANCE_API_KEY")
API_SECRET = os.getenv("BINANCE_SECRET")
BASE_URL   = "https://fapi.binance.com"

def sign(query_string: str) -> str:
    return hmac.new(
        API_SECRET.encode(),
        query_string.encode(),
        hashlib.sha256
    ).hexdigest()

def get_price(symbol):
    url = f"{BASE_URL}/fapi/v1/ticker/price?symbol={symbol}"
    res = requests.get(url)
    data = res.json()
    return float(data['price'])

def build_signed_url(symbol, side, quantity):
    endpoint = "/fapi/v1/order"
    params = {
        "symbol":     symbol,
        "side":       side,
        "type":       "MARKET",
        "quantity":   f"{quantity:.7f}",
        "recvWindow": 10000,
    }

    # query string without timestamp for pre-signing
    base_query = urllib.parse.urlencode(params, safe=":")
    return endpoint, params, base_query

def place_market_order(endpoint, params, base_query, side):
    # íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹  í›„ ì„œëª…
    params["timestamp"] = int(time.time() * 1000)
    query_string = urllib.parse.urlencode(params, safe=":")
    signature = sign(query_string)
    url = f"{BASE_URL}{endpoint}?{query_string}&signature={signature}"
    headers = {"X-MBX-APIKEY": API_KEY}

    start_time = time.time()
    res = requests.post(url, headers=headers)
    end_time = time.time()

    elapsed_ms = int((end_time - start_time) * 1000)

    try:
        response = res.json()
        print(f"ğŸ“¡ ì‘ë‹µ: {response.get('status', response)} â±ï¸ ì‹œê°„: {elapsed_ms}ms")
    except Exception as e:
        print("âŒ ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨:", e)
        return None

    return elapsed_ms

def repeat_orders(symbol, quantity, repeat_count=10):
    print("ğŸ“ˆ ìµœì´ˆ ê°€ê²© ì¡°íšŒ ì¤‘...")
    try:
        price = get_price(symbol)
        print(f"âœ… í˜„ì¬ê°€: {price}")
    except Exception as e:
        print("âŒ ê°€ê²© ì¡°íšŒ ì‹¤íŒ¨:", e)
        return

    endpoint, params_template, base_query = build_signed_url(symbol, "BUY", quantity)
    times = []

    for i in range(repeat_count):
        side = "BUY" if i % 2 == 0 else "SELL"
        print(f"\nğŸš€ {i+1}ë²ˆì§¸ {side} ì‹œì¥ê°€ ì£¼ë¬¸ ì‹¤í–‰ ì¤‘...")

        # ë”•ì…”ë„ˆë¦¬ ë³µì‚¬ í›„ ì‚¬ì´ë“œ ë³€ê²½
        params = params_template.copy()
        params["side"] = side
        base_query = urllib.parse.urlencode({k: v for k, v in params.items() if k != "timestamp"}, safe=":")

        t = place_market_order(endpoint, params, base_query, side)
        if t is not None:
            times.append(t)
        time.sleep(1)

    if len(times) >= 2:
        avg_time = sum(times[1:]) / (len(times) - 1)
        print(f"\nğŸ“Š ì²« ì£¼ë¬¸ ì œì™¸í•œ í‰ê·  ì²´ê²° ì‹œê°„ (9íšŒ): {avg_time:.1f}ms")
    else:
        print("âš ï¸ ìœ íš¨í•œ ì£¼ë¬¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.")

# âœ… ì‹¤í–‰
repeat_orders("NXPCUSDT", quantity=4, repeat_count=10)
